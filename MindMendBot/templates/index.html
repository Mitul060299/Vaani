<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mental Health Support Chatbot</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #E6E6FA 0%, #ADD8E6 100%);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .chat-container {
            background: white;
            width: 100%;
            max-width: 800px;
            height: 85vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .app-bar {
            background: white;
            padding: 15px 20px;
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-radius: 20px 20px 0 0;
        }

        .app-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin: 0;
            text-align: center;
            grid-column: 2;
        }

        .info-button {
            background: #4A90E2;
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            grid-column: 3;
            justify-self: end;
        }

        .crisis-banner {
            background: #FFF3CD;
            border-bottom: 1px solid #FFEAA7;
            padding: 8px 20px;
            text-align: center;
            font-size: 14px;
            color: #856404;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
        }

        .user .message-content {
            background: #A8E6CF;
            color: #333;
            border-bottom-right-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .bot .message-content {
            background: #F5F5F5;
            color: #333;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .bot-icon {
            font-size: 18px;
        }

        .input-section {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
        }



        .input-area {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .text-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            outline: none;
            font-size: 16px;
            transition: border-color 0.3s ease;
            background: white;
        }

        .text-input:focus {
            border-color: #4A90E2;
        }

        .send-button {
            background: #4A90E2;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 12px 20px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s ease;
        }

        .send-button:hover {
            background: #357ABD;
        }

        .input-button {
            background: #4A90E2;
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease;
        }

        .input-button:hover {
            background: #357ABD;
        }

        .input-button.disabled {
            background: #cccccc;
            cursor: not-allowed;
        }


        .status-message {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin: 10px 0;
        }

        .hidden {
            display: none;
        }


        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 500px;
            position: relative;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: black;
        }

        .permission-status {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .permission-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            color: #666;
        }

        .permission-indicator.granted {
            color: #28a745;
        }

        .permission-indicator.denied {
            color: #dc3545;
        }

        .permission-indicator.checking {
            color: #ffc107;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="app-bar">
            <h1 class="app-title">Mental Health Support</h1>
            <button class="info-button" onclick="showInfoModal()">‚ÑπÔ∏è</button>
        </div>

        <div class="crisis-banner">
            ‚ö†Ô∏è Crisis Support ‚Äî If you're in immediate crisis, please contact 988 or 911
        </div>

        <div class="chat-messages" id="chatMessages">
            <div class="message bot">
                <div class="message-content">
                    <span class="bot-icon">ü§ñ</span>
                    Hello! I'm here to provide mental health support and listen to you. Simply type your message and I'll automatically analyze your voice and facial expressions if you grant permission. How are you feeling today?
                </div>
            </div>
        </div>

        <div class="input-section">
            <div class="permission-status">
                <span id="voicePermissionStatus" class="permission-indicator">üé§ <span id="voiceStatusText">Checking...</span></span>
                <span id="cameraPermissionStatus" class="permission-indicator">üì∑ <span id="cameraStatusText">Checking...</span></span>
            </div>

            <div class="input-area">
                <input type="text" class="text-input" id="textInput" placeholder="Type your message..." onkeypress="handleKeyPress(event)">
                <button class="input-button" id="micButton" title="Microphone">üé§</button>
                <button class="input-button" id="cameraButton" title="Camera">üì∑</button>
                <button class="send-button" id="sendButton" onclick="sendMessage()">‚û°Ô∏è</button>
            </div>

            <div class="status-message" id="statusMessage"></div>
        </div>
    </div>

    <!-- Info Modal -->
    <div id="infoModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeInfoModal()">&times;</span>
            <h2>Mental Health Support Information</h2>
            <div style="margin: 20px 0;">
                <h3 style="color: #e74c3c; margin-bottom: 10px;">Crisis Support</h3>
                <p>If you're in immediate crisis or having thoughts of self-harm, please contact:</p>
                <ul style="margin: 10px 0; padding-left: 20px;">
                    <li><strong>988</strong> - Suicide & Crisis Lifeline (24/7)</li>
                    <li><strong>911</strong> - Emergency Services</li>
                    <li><strong>Crisis Text Line:</strong> Text HOME to 741741</li>
                </ul>
            </div>
            <div style="margin: 20px 0;">
                <h3 style="color: #4A90E2; margin-bottom: 10px;">About This Chatbot</h3>
                <p>This AI-powered chatbot provides mental health support through:</p>
                <ul style="margin: 10px 0; padding-left: 20px;">
                    <li>Empathetic conversation and emotional support</li>
                    <li>Optional voice emotion analysis (with microphone permission)</li>
                    <li>Optional facial expression analysis (with camera permission)</li>
                    <li>Evidence-based mental health guidance and resources</li>
                </ul>
                <p style="font-style: italic; color: #666; margin-top: 15px;">This chatbot is not a replacement for professional mental health care. Please consult with a qualified healthcare provider for diagnosis and treatment.</p>
            </div>
        </div>
    </div>

    <audio id="responseAudio" style="display: none;"></audio>

    <script>
        // Permission tracking
        let permissions = {
            microphone: localStorage.getItem('microphonePermission') || 'unknown',
            camera: localStorage.getItem('cameraPermission') || 'unknown'
        };

        // Check initial permissions on page load
        async function checkInitialPermissions() {
            try {
                // Check microphone permission
                const micResult = await navigator.permissions.query({ name: 'microphone' });
                updatePermissionStatus('microphone', micResult.state);
                micResult.onchange = () => updatePermissionStatus('microphone', micResult.state);
            } catch (error) {
                // Keep as unknown if Permissions API not supported
                updatePermissionStatus('microphone', 'unknown');
            }

            try {
                // Check camera permission
                const camResult = await navigator.permissions.query({ name: 'camera' });
                updatePermissionStatus('camera', camResult.state);
                camResult.onchange = () => updatePermissionStatus('camera', camResult.state);
            } catch (error) {
                // Keep as unknown if Permissions API not supported
                updatePermissionStatus('camera', 'unknown');
            }
        }

        function updatePermissionStatus(type, state) {
            const statusElement = document.getElementById(type === 'microphone' ? 'voiceStatusText' : 'cameraStatusText');
            const indicatorElement = document.getElementById(type === 'microphone' ? 'voicePermissionStatus' : 'cameraPermissionStatus');
            const buttonElement = document.getElementById(type === 'microphone' ? 'micButton' : 'cameraButton');
            
            // Remove all permission classes
            indicatorElement.classList.remove('granted', 'denied', 'checking');
            buttonElement.classList.remove('disabled');
            
            switch(state) {
                case 'granted':
                    statusElement.textContent = 'Enabled';
                    indicatorElement.classList.add('granted');
                    permissions[type] = 'granted';
                    localStorage.setItem(type + 'Permission', 'granted');
                    break;
                case 'denied':
                    statusElement.textContent = 'Disabled';
                    indicatorElement.classList.add('denied');
                    buttonElement.classList.add('disabled');
                    permissions[type] = 'denied';
                    localStorage.setItem(type + 'Permission', 'denied');
                    break;
                default:
                    statusElement.textContent = 'Unknown';
                    indicatorElement.classList.add('checking');
                    permissions[type] = 'unknown';
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        async function requestPermissions() {
            let audioStream = null;
            let videoStream = null;

            // Request microphone permission if not already granted
            if (permissions.microphone !== 'granted') {
                try {
                    audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    updatePermissionStatus('microphone', 'granted');
                } catch (error) {
                    updatePermissionStatus('microphone', 'denied');
                    console.log('Microphone access denied:', error);
                }
            }

            // Request camera permission if not already granted
            if (permissions.camera !== 'granted') {
                try {
                    videoStream = await navigator.mediaDevices.getUserMedia({ video: true });
                    updatePermissionStatus('camera', 'granted');
                } catch (error) {
                    updatePermissionStatus('camera', 'denied');
                    console.log('Camera access denied:', error);
                }
            }

            return { audioStream, videoStream };
        }

        async function captureAudio() {
            if (permissions.microphone !== 'granted') return null;

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const mediaRecorder = new MediaRecorder(stream);
                const audioChunks = [];

                return new Promise((resolve) => {
                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        stream.getTracks().forEach(track => track.stop());
                        resolve(audioBlob);
                    };

                    mediaRecorder.start();
                    setTimeout(() => {
                        if (mediaRecorder.state === 'recording') {
                            mediaRecorder.stop();
                        }
                    }, 5000);
                });
            } catch (error) {
                console.log('Audio capture failed:', error);
                return null;
            }
        }

        async function capturePhoto() {
            if (permissions.camera !== 'granted') return null;

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                const video = document.createElement('video');
                video.srcObject = stream;
                video.autoplay = true;

                return new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(video, 0, 0);
                        
                        canvas.toBlob((blob) => {
                            stream.getTracks().forEach(track => track.stop());
                            resolve(blob);
                        }, 'image/jpeg', 0.8);
                    };
                });
            } catch (error) {
                console.log('Photo capture failed:', error);
                return null;
            }
        }

        function appendMessage(content, isUser = false, isAudio = false) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            if (!isUser) {
                const botIcon = document.createElement('span');
                botIcon.className = 'bot-icon';
                botIcon.textContent = 'ü§ñ';
                contentDiv.appendChild(botIcon);
            }
            
            const textSpan = document.createElement('span');
            textSpan.textContent = content;
            contentDiv.appendChild(textSpan);
            
            messageDiv.appendChild(contentDiv);
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            if (isAudio && !isUser) {
                playAudio(content);
            }
        }

        function playAudio(base64Audio) {
            if (base64Audio) {
                const audio = document.getElementById('responseAudio');
                audio.src = `data:audio/mpeg;base64,${base64Audio}`;
                audio.play().catch(e => console.log('Audio play failed:', e));
            }
        }

        async function sendMessage() {
            const input = document.getElementById('textInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Show user message
            appendMessage(message, true);
            input.value = '';
            
            // Disable send button and show status
            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = true;
            sendButton.textContent = 'Sending...';
            document.getElementById('statusMessage').textContent = 'Requesting permissions and capturing data...';
            
            try {
                // Request permissions on first send if needed
                if (permissions.microphone === 'unknown' || permissions.camera === 'unknown') {
                    await requestPermissions();
                }
                
                // Capture audio and photo simultaneously if permissions are granted
                const [audioBlob, photoBlob] = await Promise.all([
                    permissions.microphone === 'granted' ? captureAudio() : Promise.resolve(null),
                    permissions.camera === 'granted' ? capturePhoto() : Promise.resolve(null)
                ]);
                
                document.getElementById('statusMessage').textContent = 'Processing your message...';
                
                // Prepare form data for unified endpoint
                const formData = new FormData();
                formData.append('message', message);
                
                if (audioBlob) {
                    formData.append('audio', audioBlob, 'recording.wav');
                }
                
                if (photoBlob) {
                    formData.append('image', photoBlob, 'capture.jpg');
                }
                
                // Send to unified endpoint
                const response = await fetch('/process', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.reply) {
                    appendMessage(data.reply, false);
                    if (data.audio) {
                        playAudio(data.audio);
                    }
                }
                
                // Show feedback about what was captured
                let captureInfo = [];
                if (audioBlob) captureInfo.push('voice analyzed');
                if (photoBlob) captureInfo.push('facial expression analyzed');
                if (captureInfo.length === 0) captureInfo.push('text only');
                
                document.getElementById('statusMessage').textContent = `Message processed (${captureInfo.join(', ')})`;
                setTimeout(() => {
                    document.getElementById('statusMessage').textContent = '';
                }, 3000);
                
            } catch (error) {
                console.error('Send message error:', error);
                appendMessage('Sorry, I encountered an error. Please try again.', false);
                document.getElementById('statusMessage').textContent = 'Error occurred';
                setTimeout(() => {
                    document.getElementById('statusMessage').textContent = '';
                }, 3000);
            } finally {
                // Re-enable send button
                sendButton.disabled = false;
                sendButton.textContent = 'Send';
            }
        }

        function showInfoModal() {
            const modal = document.getElementById('infoModal');
            modal.style.display = 'block';
        }

        function closeInfoModal() {
            const modal = document.getElementById('infoModal');
            modal.style.display = 'none';
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            checkInitialPermissions();
            
            // Close modal when clicking outside
            window.onclick = function(event) {
                const modal = document.getElementById('infoModal');
                if (event.target === modal) {
                    closeInfoModal();
                }
            }
        });


    </script>
</body>
</html>